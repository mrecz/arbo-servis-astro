---
import Logo from './logo.astro';
import MobileMenu from './mobile-menu.tsx';

interface Props {
  mode?: string;
}

const { mode = 'dark' } = Astro.props;

// Get current page path for active state
const currentPath = Astro.url.pathname;

// Helper function to check if a menu item is active
function isActive(path: string): boolean {
  if (path === '/' && currentPath === '/') return true;
  if (path !== '/' && currentPath.startsWith(path)) return true;
  return false;
}
---

<header id="header" class={`fixed top-0 w-full z-30 ${mode !== 'light' && 'dark'}`}>
  <div class="max-w-[85rem] mx-auto px-5 sm:px-6">
    <div class="flex items-center justify-between h-28 lg:h-40">
      <!-- Site branding -->
      <div class="shrink-0 mr-4">
        <Logo logo="white" />
      </div>
      <!-- Company name for mobile -->
      <div class={`lg:hidden ${currentPath === '/' ? 'hidden' : 'block'}`} id="company-name">
        <h1 class="h1 font-montserrat text-2xl md:text-5xl text-carmine-800 tracking-wide">
          arbo-servis.cz
        </h1>
      </div>
      <!-- Desktop navigation -->
      <nav class="hidden lg:flex lg:grow">
        <!-- Desktop menu links -->
        <ul class="flex grow justify-start flex-wrap items-center gap-2">
          <li>
            <a
              href="/"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>Úvod</a
            >
          </li>
          <li>
            <a
              href="/nabizene-sluzby"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/nabizene-sluzby')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>Nabízené služby</a
            >
          </li>
          <li>
            <a
              href="/zajem-o-sluzbu"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/zajem-o-sluzbu')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>Zajímáte se o službu?</a
            >
          </li>
          <li>
            <a
              href="/o-nas"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/o-nas')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>O nás</a
            >
          </li>
          <li>
            <a
              href="/cena"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/cena')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>Cena</a
            >
          </li>
          <li>
            <a
              href="/reference"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/reference')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>Reference</a
            >
          </li>
          <li>
            <a
              href="/osvedceni"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg ${
                isActive('/osvedceni')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-latte-800 hover:text-carmine-600 dark:text-latte-400 dark:hover:text-carmine-600 hover:bg-latte-600/5 dark:hover:bg-latte-400/5'
              }`}>Osvědčení</a
            >
          </li>
        </ul>

        <!-- Desktop contact link -->
        <ul class="flex grow justify-end flex-wrap items-center">
          <li>
            <a
              href="/kontakt"
              class={`xl:text-lg text-sm font-semibold px-4 lg:px-6 py-3 flex items-center transition duration-200 ease-in-out rounded-lg group ${
                isActive('/kontakt')
                  ? 'text-carmine-600 dark:text-carmine-400 bg-carmine-600/10 dark:bg-carmine-400/10'
                  : 'text-carmine-600 dark:text-latte-300 dark:hover:text-white bg-latte-600/10 dark:bg-latte-400/10 hover:bg-carmine-600/10 dark:hover:bg-carmine-400/10'
              }`}
            >
              Kontakt <span
                class="tracking-normal text-carmine-600 group-hover:translate-x-0.5 transition-transform duration-200 ease-in-out ml-1"
                >-&gt;</span
              >
            </a>
          </li>
        </ul>
      </nav>
      <!-- Mobile navigation -->
      <MobileMenu client:load />
    </div>
  </div>
</header>

<script>
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function () {
    const header = document.getElementById('header');
    const companyName = document.getElementById('company-name');
    const currentPath = window.location.pathname;
    if (!header || !companyName) return;

    // Configuration
    const SCROLL_THRESHOLD = 10;
    const SCROLL_DEBOUNCE_DELAY = 16; // ~60fps

    // State tracking
    let isScrolled = false;
    let scrollTimeout: number | null = null;

    // Optimized scroll handler with debouncing
    function handleScroll() {
      if (scrollTimeout) {
        cancelAnimationFrame(scrollTimeout);
      }

      scrollTimeout = requestAnimationFrame(() => {
        const currentScrollY = window.scrollY;
        const shouldShow = currentScrollY > SCROLL_THRESHOLD;

        // Only update if state changed (performance optimization)
        if (shouldShow !== isScrolled) {
          isScrolled = shouldShow;
          updateElementVisibility();
        }
      });
    }

    // Separate function for updating element visibility
    function updateElementVisibility() {
      if (!companyName || !header) return;

      const isIndexPage = currentPath === '/';

      if (isScrolled) {
        // Show company name on mobile when scrolled
        companyName.classList.remove('hidden');
        companyName.classList.add('block', 'lg:hidden');

        // Add header background
        header.classList.add(
          'bg-grey-950/80',
          'backdrop-blur-sm',
          'border-b',
          'border-grey-200/50'
        );

        // Add dark mode background if needed
        if (header.classList.contains('dark')) {
          header.classList.add('dark:bg-grey-950/95', 'dark:border-grey-700/50');
        }
      } else {
        // On index page: hide company name when at top
        // On other pages: always show company name on mobile
        if (isIndexPage) {
          companyName.classList.remove('block', 'lg:hidden');
          companyName.classList.add('hidden');
        } else {
          // Always show on non-index pages
          companyName.classList.remove('hidden');
          companyName.classList.add('block', 'lg:hidden');
        }

        // Remove header background
        header.classList.remove(
          'bg-grey-950/80',
          'backdrop-blur-sm',
          'border-b',
          'border-grey-200/50',
          'dark:bg-grey-950/95',
          'dark:border-grey-700/50'
        );
      }
    }

    // Add scroll event listener with passive option for better performance
    window.addEventListener('scroll', handleScroll, { passive: true });

    // Check initial scroll position
    handleScroll();

    // Cleanup function (optional, for SPA navigation)
    return () => {
      window.removeEventListener('scroll', handleScroll);
      if (scrollTimeout) {
        cancelAnimationFrame(scrollTimeout);
      }
    };
  });
</script>
